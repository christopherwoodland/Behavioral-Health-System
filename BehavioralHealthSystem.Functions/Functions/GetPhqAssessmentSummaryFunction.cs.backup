using Azure.Storage.Blobs;
using Azure.Storage.Blobs.Models;

namespace BehavioralHealthSystem.Functions.Functions;

/// <summary>
/// Azure Function to retrieve and summarize PHQ assessment data from chat transcripts
/// All PHQ assessment data is stored in chat-transcripts container with PHQ-related metadata
/// </summary>
public class GetPhqAssessmentSummaryFunction
{
    private readonly ILogger<GetPhqAssessmentSummaryFunction> _logger;
    private readonly BlobServiceClient _blobServiceClient;

    public GetPhqAssessmentSummaryFunction(
        ILogger<GetPhqAssessmentSummaryFunction> logger,
        BlobServiceClient blobServiceClient)
    {
        _logger = logger ?? throw new ArgumentNullException(nameof(logger));
        _blobServiceClient = blobServiceClient ?? throw new ArgumentNullException(nameof(blobServiceClient));
    }

    [Function("GetPhqAssessmentSummary")]
    public async Task<HttpResponseData> Run(
        [HttpTrigger(AuthorizationLevel.Function, "get", "post")] HttpRequestData req)
    {
        try
        {
            _logger.LogInformation("Processing PHQ assessment summary request");

            // Parse query parameters for GET, or body for POST
            string? userId = null;
            string? sessionId = null;
            string? assessmentId = null;
            int? limit = null;

            if (req.Method == "GET")
            {
                var query = System.Web.HttpUtility.ParseQueryString(req.Url.Query);
                userId = query["userId"];
                sessionId = query["sessionId"];
                assessmentId = query["assessmentId"];
                if (int.TryParse(query["limit"], out var limitValue))
                {
                    limit = limitValue;
                }
            }
            else // POST
            {
                var requestBody = await new StreamReader(req.Body).ReadToEndAsync();
                var deserializeOptions = new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true,
                    PropertyNamingPolicy = JsonNamingPolicy.CamelCase
                };
                var requestData = JsonSerializer.Deserialize<GetAssessmentSummaryRequest>(requestBody, deserializeOptions);
                userId = requestData?.UserId;
                sessionId = requestData?.SessionId;
                assessmentId = requestData?.AssessmentId;
                limit = requestData?.Limit;
            }

            // Validate required parameter
            if (string.IsNullOrEmpty(userId))
            {
                _logger.LogWarning("Invalid request: userId is required");
                var badResponse = req.CreateResponse(System.Net.HttpStatusCode.BadRequest);
                await badResponse.WriteStringAsync("userId is required");
                return badResponse;
            }

            _logger.LogInformation("Fetching PHQ assessment summary for userId: {UserId}, sessionId: {SessionId}, assessmentId: {AssessmentId}",
                userId, sessionId, assessmentId);

            // Build comprehensive summary
            var summary = await BuildAssessmentSummaryAsync(userId, sessionId, assessmentId, limit ?? 10);

            var response = req.CreateResponse(System.Net.HttpStatusCode.OK);
            response.Headers.Add("Content-Type", "application/json");
            await response.WriteStringAsync(JsonSerializer.Serialize(summary, new JsonSerializerOptions
            {
                WriteIndented = true,
                PropertyNamingPolicy = JsonNamingPolicy.CamelCase
            }));

            return response;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error processing PHQ assessment summary request");
            var errorResponse = req.CreateResponse(System.Net.HttpStatusCode.InternalServerError);
            await errorResponse.WriteStringAsync("Internal server error");
            return errorResponse;
        }
    }

    private async Task<PhqAssessmentSummary> BuildAssessmentSummaryAsync(
        string userId,
        string? sessionId,
        string? assessmentId,
        int limit)
    {
        var summary = new PhqAssessmentSummary
        {
            UserId = userId,
            SessionId = sessionId,
            AssessmentId = assessmentId,
            RetrievedAt = DateTime.UtcNow.ToString("O"),
            Assessments = new List<AssessmentSummaryItem>(),
            Sessions = new List<SessionSummaryItem>(),
            ConversationHighlights = new List<ConversationHighlight>()
        };

        // Fetch assessment data from 'phq' container
        var assessments = await FetchAssessmentsAsync(userId, assessmentId, limit);
        summary.Assessments = assessments;

        // Fetch session data from 'phq-sessions' container
        var sessions = await FetchSessionsAsync(userId, sessionId, assessmentId, limit);
        summary.Sessions = sessions;

        // Fetch related chat transcripts from 'chat-transcripts' container
        var conversationHighlights = await FetchConversationHighlightsAsync(userId, sessionId, limit);
        summary.ConversationHighlights = conversationHighlights;

        // Generate summary insights
        summary.SummaryInsights = GenerateSummaryInsights(assessments, sessions, conversationHighlights);

        return summary;
    }

    private async Task<List<AssessmentSummaryItem>> FetchAssessmentsAsync(
        string userId,
        string? assessmentId,
        int limit)
    {
        var results = new List<AssessmentSummaryItem>();

        try
        {
            var containerClient = _blobServiceClient.GetBlobContainerClient("phq");

            if (!await containerClient.ExistsAsync())
            {
                _logger.LogWarning("PHQ container does not exist");
                return results;
            }

            var prefix = $"users/{userId}/";
            var blobsList = new List<BlobItem>();

            await foreach (var blobItem in containerClient.GetBlobsAsync(prefix: prefix))
            {
                blobsList.Add(blobItem);
            }

            var sortedBlobs = blobsList
                .OrderByDescending(b => b.Properties.CreatedOn)
                .Take(limit);

            foreach (var blobItem in sortedBlobs)
            {
                // Filter by assessmentId if specified
                if (!string.IsNullOrEmpty(assessmentId))
                {
                    if (!blobItem.Metadata.TryGetValue("assessment_id", out var blobAssessmentId) ||
                        blobAssessmentId != assessmentId)
                    {
                        continue;
                    }
                }

                var blobClient = containerClient.GetBlobClient(blobItem.Name);
                var content = await blobClient.DownloadContentAsync();
                var jsonText = content.Value.Content.ToString();

                var deserializeOptions = new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true,
                    PropertyNamingPolicy = JsonNamingPolicy.CamelCase
                };

                var assessmentData = JsonSerializer.Deserialize<AssessmentBlobData>(jsonText, deserializeOptions);

                if (assessmentData?.Assessment != null)
                {
                    results.Add(new AssessmentSummaryItem
                    {
                        AssessmentId = assessmentData.Assessment.AssessmentId,
                        AssessmentType = assessmentData.Assessment.AssessmentType,
                        StartTime = assessmentData.Assessment.StartTime,
                        CompletedTime = assessmentData.Assessment.CompletedTime,
                        IsCompleted = assessmentData.Assessment.IsCompleted,
                        TotalScore = assessmentData.Assessment.TotalScore,
                        Severity = assessmentData.Assessment.Severity,
                        Interpretation = assessmentData.Assessment.Interpretation,
                        Recommendations = assessmentData.Assessment.Recommendations,
                        QuestionCount = assessmentData.Assessment.Questions?.Count ?? 0,
                        AnsweredCount = assessmentData.Assessment.Questions?.Count(q => q.Answer.HasValue) ?? 0,
                        SessionId = assessmentData.Assessment.Metadata?.SessionId
                    });
                }
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error fetching PHQ assessments for userId: {UserId}", userId);
        }

        return results;
    }

    private async Task<List<SessionSummaryItem>> FetchSessionsAsync(
        string userId,
        string? sessionId,
        string? assessmentId,
        int limit)
    {
        var results = new List<SessionSummaryItem>();

        try
        {
            var containerClient = _blobServiceClient.GetBlobContainerClient("phq-sessions");

            if (!await containerClient.ExistsAsync())
            {
                _logger.LogWarning("PHQ sessions container does not exist");
                return results;
            }

            var prefix = $"users/{userId}/";
            var blobsList = new List<BlobItem>();

            await foreach (var blobItem in containerClient.GetBlobsAsync(prefix: prefix))
            {
                blobsList.Add(blobItem);
            }

            var sortedBlobs = blobsList
                .OrderByDescending(b => b.Properties.CreatedOn)
                .Take(limit);

            foreach (var blobItem in sortedBlobs)
            {
                // Filter by sessionId or assessmentId if specified
                if (!string.IsNullOrEmpty(sessionId))
                {
                    if (!blobItem.Metadata.TryGetValue("session_id", out var blobSessionId) ||
                        blobSessionId != sessionId)
                    {
                        continue;
                    }
                }

                if (!string.IsNullOrEmpty(assessmentId))
                {
                    if (!blobItem.Metadata.TryGetValue("assessment_id", out var blobAssessmentId) ||
                        blobAssessmentId != assessmentId)
                    {
                        continue;
                    }
                }

                var blobClient = containerClient.GetBlobClient(blobItem.Name);
                var content = await blobClient.DownloadContentAsync();
                var jsonText = content.Value.Content.ToString();

                var deserializeOptions = new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true,
                    PropertyNamingPolicy = JsonNamingPolicy.CamelCase
                };

                var sessionData = JsonSerializer.Deserialize<PhqSessionData>(jsonText, deserializeOptions);

                if (sessionData != null)
                {
                    results.Add(new SessionSummaryItem
                    {
                        SessionId = sessionData.SessionId,
                        AssessmentId = sessionData.AssessmentId,
                        AssessmentType = sessionData.AssessmentType,
                        CreatedAt = sessionData.CreatedAt,
                        LastUpdated = sessionData.LastUpdated,
                        CompletedAt = sessionData.CompletedAt,
                        IsCompleted = sessionData.IsCompleted,
                        TotalScore = sessionData.TotalScore,
                        Severity = sessionData.Severity,
                        QuestionCount = sessionData.Questions?.Count ?? 0,
                        AnsweredCount = sessionData.Questions?.Count(q => q.Answer.HasValue) ?? 0,
                        SkippedCount = sessionData.Questions?.Count(q => q.Skipped) ?? 0,
                        ConversationSessionId = sessionData.Metadata?.ConversationSessionId
                    });
                }
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error fetching PHQ sessions for userId: {UserId}", userId);
        }

        return results;
    }

    private async Task<List<ConversationHighlight>> FetchConversationHighlightsAsync(
        string userId,
        string? sessionId,
        int limit)
    {
        var results = new List<ConversationHighlight>();

        try
        {
            var containerClient = _blobServiceClient.GetBlobContainerClient("chat-transcripts");

            if (!await containerClient.ExistsAsync())
            {
                _logger.LogWarning("Chat transcripts container does not exist");
                return results;
            }

            var prefix = $"users/{userId}/conversations/";
            var blobsList = new List<BlobItem>();

            await foreach (var blobItem in containerClient.GetBlobsAsync(prefix: prefix))
            {
                blobsList.Add(blobItem);
            }

            var sortedBlobs = blobsList
                .OrderByDescending(b => b.Properties.LastModified)
                .Take(limit);

            foreach (var blobItem in sortedBlobs)
            {
                // Filter by sessionId if specified
                if (!string.IsNullOrEmpty(sessionId))
                {
                    if (!blobItem.Name.Contains(sessionId))
                    {
                        continue;
                    }
                }

                var blobClient = containerClient.GetBlobClient(blobItem.Name);
                var content = await blobClient.DownloadContentAsync();
                var jsonText = content.Value.Content.ToString();

                var deserializeOptions = new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true,
                    PropertyNamingPolicy = JsonNamingPolicy.CamelCase
                };

                var transcriptData = JsonSerializer.Deserialize<ChatTranscriptData>(jsonText, deserializeOptions);

                if (transcriptData != null)
                {
                    // Extract PHQ-related messages
                    var phqMessages = transcriptData.Messages?
                        .Where(m => m.Content != null && (
                            m.Content.Contains("PHQ", StringComparison.OrdinalIgnoreCase) ||
                            m.Content.Contains("depression", StringComparison.OrdinalIgnoreCase) ||
                            m.Content.Contains("mood", StringComparison.OrdinalIgnoreCase) ||
                            m.Content.Contains("Jekyll", StringComparison.OrdinalIgnoreCase) ||
                            m.Metadata != null && m.Metadata.ContainsKey("phq_question_number")
                        ))
                        .Take(10)
                        .Select(m => new MessageHighlight
                        {
                            MessageId = m.Id,
                            Role = m.Role,
                            Content = TruncateContent(m.Content, 200),
                            Timestamp = m.Timestamp,
                            PhqQuestionNumber = m.Metadata?.ContainsKey("phq_question_number") == true
                                ? int.Parse(m.Metadata["phq_question_number"]?.ToString() ?? "0")
                                : null
                        })
                        .ToList();

                    if (phqMessages?.Any() == true)
                    {
                        results.Add(new ConversationHighlight
                        {
                            SessionId = transcriptData.SessionId,
                            UserId = transcriptData.UserId,
                            StartTime = transcriptData.StartTime,
                            LastMessageTime = transcriptData.LastMessageTime,
                            MessageCount = transcriptData.Messages?.Count ?? 0,
                            PhqRelatedMessages = phqMessages
                        });
                    }
                }
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error fetching conversation highlights for userId: {UserId}", userId);
        }

        return results;
    }

    private SummaryInsights GenerateSummaryInsights(
        List<AssessmentSummaryItem> assessments,
        List<SessionSummaryItem> sessions,
        List<ConversationHighlight> conversations)
    {
        var insights = new SummaryInsights
        {
            TotalAssessments = assessments.Count,
            CompletedAssessments = assessments.Count(a => a.IsCompleted),
            TotalSessions = sessions.Count,
            TotalConversations = conversations.Count
        };

        // Latest assessment
        var latestAssessment = assessments.OrderByDescending(a => a.StartTime).FirstOrDefault();
        if (latestAssessment != null)
        {
            insights.LatestAssessment = new LatestAssessmentInfo
            {
                AssessmentId = latestAssessment.AssessmentId,
                AssessmentType = latestAssessment.AssessmentType,
                CompletedTime = latestAssessment.CompletedTime,
                TotalScore = latestAssessment.TotalScore,
                Severity = latestAssessment.Severity,
                Interpretation = latestAssessment.Interpretation
            };
        }

        // Score trend (if multiple completed assessments)
        var completedAssessments = assessments
            .Where(a => a.IsCompleted && a.TotalScore.HasValue)
            .OrderBy(a => a.StartTime)
            .ToList();

        if (completedAssessments.Count > 1)
        {
            var firstScore = completedAssessments.First().TotalScore!.Value;
            var lastScore = completedAssessments.Last().TotalScore!.Value;
            var scoreDiff = lastScore - firstScore;

            insights.ScoreTrend = scoreDiff > 0 ? "Increasing" :
                                  scoreDiff < 0 ? "Decreasing" :
                                  "Stable";
            insights.ScoreChange = scoreDiff;
        }

        // Average completion rate
        if (sessions.Any())
        {
            insights.AverageCompletionRate = sessions.Average(s =>
                s.QuestionCount > 0 ? (double)s.AnsweredCount / s.QuestionCount * 100 : 0);
        }

        return insights;
    }

    private string TruncateContent(string? content, int maxLength)
    {
        if (string.IsNullOrEmpty(content))
            return string.Empty;

        if (content.Length <= maxLength)
            return content;

        return content.Substring(0, maxLength) + "...";
    }

    // Request/Response Models
    public class GetAssessmentSummaryRequest
    {
        public string UserId { get; set; } = "";
        public string? SessionId { get; set; }
        public string? AssessmentId { get; set; }
        public int? Limit { get; set; }
    }

    public class PhqAssessmentSummary
    {
        public string UserId { get; set; } = "";
        public string? SessionId { get; set; }
        public string? AssessmentId { get; set; }
        public string RetrievedAt { get; set; } = "";
        public List<AssessmentSummaryItem> Assessments { get; set; } = new();
        public List<SessionSummaryItem> Sessions { get; set; } = new();
        public List<ConversationHighlight> ConversationHighlights { get; set; } = new();
        public SummaryInsights? SummaryInsights { get; set; }
    }

    public class AssessmentSummaryItem
    {
        public string AssessmentId { get; set; } = "";
        public string AssessmentType { get; set; } = "";
        public string StartTime { get; set; } = "";
        public string? CompletedTime { get; set; }
        public bool IsCompleted { get; set; }
        public int? TotalScore { get; set; }
        public string? Severity { get; set; }
        public string? Interpretation { get; set; }
        public List<string>? Recommendations { get; set; }
        public int QuestionCount { get; set; }
        public int AnsweredCount { get; set; }
        public string? SessionId { get; set; }
    }

    public class SessionSummaryItem
    {
        public string SessionId { get; set; } = "";
        public string AssessmentId { get; set; } = "";
        public string AssessmentType { get; set; } = "";
        public string CreatedAt { get; set; } = "";
        public string LastUpdated { get; set; } = "";
        public string? CompletedAt { get; set; }
        public bool IsCompleted { get; set; }
        public int? TotalScore { get; set; }
        public string? Severity { get; set; }
        public int QuestionCount { get; set; }
        public int AnsweredCount { get; set; }
        public int SkippedCount { get; set; }
        public string? ConversationSessionId { get; set; }
    }

    public class ConversationHighlight
    {
        public string SessionId { get; set; } = "";
        public string UserId { get; set; } = "";
        public string? StartTime { get; set; }
        public string? LastMessageTime { get; set; }
        public int MessageCount { get; set; }
        public List<MessageHighlight>? PhqRelatedMessages { get; set; }
    }

    public class MessageHighlight
    {
        public string MessageId { get; set; } = "";
        public string Role { get; set; } = "";
        public string Content { get; set; } = "";
        public string? Timestamp { get; set; }
        public int? PhqQuestionNumber { get; set; }
    }

    public class SummaryInsights
    {
        public int TotalAssessments { get; set; }
        public int CompletedAssessments { get; set; }
        public int TotalSessions { get; set; }
        public int TotalConversations { get; set; }
        public LatestAssessmentInfo? LatestAssessment { get; set; }
        public string? ScoreTrend { get; set; }
        public int? ScoreChange { get; set; }
        public double? AverageCompletionRate { get; set; }
    }

    public class LatestAssessmentInfo
    {
        public string AssessmentId { get; set; } = "";
        public string AssessmentType { get; set; } = "";
        public string? CompletedTime { get; set; }
        public int? TotalScore { get; set; }
        public string? Severity { get; set; }
        public string? Interpretation { get; set; }
    }

    // Helper models for deserialization
    public class AssessmentBlobData
    {
        public AssessmentData? Assessment { get; set; }
        public StorageMetadata? StorageMetadata { get; set; }
    }

    public class AssessmentData
    {
        public string AssessmentId { get; set; } = "";
        public string UserId { get; set; } = "";
        public string AssessmentType { get; set; } = "";
        public string StartTime { get; set; } = "";
        public string? CompletedTime { get; set; }
        public bool IsCompleted { get; set; }
        public List<QuestionData>? Questions { get; set; }
        public int? TotalScore { get; set; }
        public string? Severity { get; set; }
        public string? Interpretation { get; set; }
        public List<string>? Recommendations { get; set; }
        public AssessmentMetadata? Metadata { get; set; }
    }

    public class QuestionData
    {
        public int QuestionNumber { get; set; }
        public string QuestionText { get; set; } = "";
        public int? Answer { get; set; }
        public int Attempts { get; set; }
        public bool Skipped { get; set; }
        public string? Timestamp { get; set; }
    }

    public class AssessmentMetadata
    {
        public string? SessionId { get; set; }
        public string? UserAgent { get; set; }
        public string? IpAddress { get; set; }
        public string Version { get; set; } = "1.0.0";
    }

    public class StorageMetadata
    {
        public string? SavedAt { get; set; }
        public string? SavedBy { get; set; }
        public string? Version { get; set; }
    }

    public class PhqSessionData
    {
        public string UserId { get; set; } = "";
        public string SessionId { get; set; } = "";
        public string AssessmentId { get; set; } = "";
        public string AssessmentType { get; set; } = "";
        public string CreatedAt { get; set; } = "";
        public string LastUpdated { get; set; } = "";
        public string? CompletedAt { get; set; }
        public bool IsCompleted { get; set; }
        public List<QuestionData>? Questions { get; set; }
        public int? TotalScore { get; set; }
        public string? Severity { get; set; }
        public PhqSessionMetadata? Metadata { get; set; }
    }

    public class PhqSessionMetadata
    {
        public string ConversationSessionId { get; set; } = "";
        public string? UserAgent { get; set; }
        public string? ClientTimezone { get; set; }
        public string Version { get; set; } = "1.0.0";
    }

    public class ChatTranscriptData
    {
        public string UserId { get; set; } = "";
        public string SessionId { get; set; } = "";
        public string? StartTime { get; set; }
        public string? LastMessageTime { get; set; }
        public List<MessageData>? Messages { get; set; }
    }

    public class MessageData
    {
        public string Id { get; set; } = "";
        public string Role { get; set; } = "";
        public string? Content { get; set; }
        public string? Timestamp { get; set; }
        public Dictionary<string, object>? Metadata { get; set; }
    }
}
