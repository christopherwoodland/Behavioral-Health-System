services:
  # BHS Functions API - Development Environment
  # Uses Managed Identity and Azure resources (mirrors production setup)
  api:
    image: bhs-api:development
    container_name: bhs-api-dev
    build:
      context: .
      dockerfile: BehavioralHealthSystem.Functions/Dockerfile.development
    ports:
      - "7071:80"
    environment:
      # Storage connection - Uses Managed Identity (account name only)
      - AzureWebJobsStorage__accountName=${STORAGE_ACCOUNT_NAME}
      - DSM5_STORAGE_ACCOUNT_NAME=${DSM5_STORAGE_ACCOUNT_NAME}
      # Application Insights - Key Vault reference
      - APPLICATIONINSIGHTS_CONNECTION_STRING=${APPLICATIONINSIGHTS_CONNECTION_STRING}
      # Functions runtime
      - FUNCTIONS_WORKER_RUNTIME=dotnet-isolated
      - ASPNETCORE_ENVIRONMENT=Development
      - AZURE_FUNCTIONS_ENVIRONMENT=Development
      # Kintsugi API - Key from Key Vault reference
      - KINTSUGI_API_KEY=${KINTSUGI_API_KEY}
      - KINTSUGI_BASE_URL=https://api.kintsugihealth.com/v2
      - KINTSUGI_TIMEOUT_SECONDS=300
      - KINTSUGI_MAX_RETRY_ATTEMPTS=3
      - KINTSUGI_RETRY_DELAY_MS=1000
      - KINTSUGI_AUTO_PROVIDE_CONSENT=false
      # Azure Speech - Managed Identity (no key)
      - AZURE_SPEECH_ENDPOINT=${AZURE_SPEECH_ENDPOINT}
      - AZURE_SPEECH_REGION=${AZURE_SPEECH_REGION}
      - AZURE_SPEECH_LOCALE=en-US
      - AZURE_SPEECH_API_VERSION=2024-11-15
      # Storage
      - DSM5_CONTAINER_NAME=dsm5-data
      - DSM5_EXTRACTION_METHOD=CONTENT_UNDERSTANDING
      # Azure OpenAI - Managed Identity (no key)
      - AZURE_OPENAI_ENABLED=true
      - AZURE_OPENAI_API_VERSION=2024-12-01-preview
      - AZURE_OPENAI_DEPLOYMENT=gpt-4.1
      - AZURE_OPENAI_ENDPOINT=${AZURE_OPENAI_ENDPOINT}
      # Extended Assessment OpenAI - Managed Identity (no key)
      - EXTENDED_ASSESSMENT_OPENAI_ENABLED=true
      - EXTENDED_ASSESSMENT_OPENAI_API_VERSION=2024-12-01-preview
      - EXTENDED_ASSESSMENT_OPENAI_DEPLOYMENT=gpt-5
      - EXTENDED_ASSESSMENT_OPENAI_ENDPOINT=${EXTENDED_ASSESSMENT_OPENAI_ENDPOINT}
      - EXTENDED_ASSESSMENT_OPENAI_MAX_TOKENS=4000
      - EXTENDED_ASSESSMENT_OPENAI_TEMPERATURE=0.2
      - EXTENDED_ASSESSMENT_OPENAI_TIMEOUT_SECONDS=120
      - EXTENDED_ASSESSMENT_USE_FALLBACK=false
      # Agent mode
      - AGENT_MODE_ENABLED=false
      # Content Understanding - Managed Identity (no key)
      - AZURE_CONTENT_UNDERSTANDING_ENDPOINT=${AZURE_CONTENT_UNDERSTANDING_ENDPOINT}
      # Document Intelligence - Managed Identity (no key)
      - DocumentIntelligenceEndpoint=${DOCUMENT_INTELLIGENCE_ENDPOINT}
      - DSM5_DOCUMENT_INTELLIGENCE_ENDPOINT=${DSM5_DOCUMENT_INTELLIGENCE_ENDPOINT}
      # Grammar Correction Agent - Managed Identity (no API key)
      - AGENT_ENDPOINT=${AGENT_ENDPOINT}
      - AGENT_MODEL_DEPLOYMENT=gpt-5
      - AGENT_ENABLED=true
      - AGENT_SUPPORTS_TEMPERATURE=false
      - AGENT_SUPPORTS_MAX_TOKENS=false
      - AGENT_TIMEOUT_SECONDS=60
      - GRAMMAR_AGENT_NAME=GrammarCorrectionAgent
      - GRAMMAR_AGENT_INCLUDE_EXPLANATIONS=false
      - GRAMMAR_AGENT_PRESERVE_FORMATTING=true
      - GRAMMAR_AGENT_SUGGEST_ALTERNATIVES=false
      # Azure Identity for Managed Identity
      - AZURE_TENANT_ID=${AZURE_TENANT_ID}
      - AZURE_CLIENT_ID=${AZURE_CLIENT_ID}
      # Entra ID
      - ENTRA_TENANT_ID=${ENTRA_TENANT_ID}
      - ENTRA_CLIENT_ID=${ENTRA_CLIENT_ID}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/api/health"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  # BHS Web UI - Development Environment
  web:
    image: bhs-web:development
    container_name: bhs-web-dev
    build:
      context: ./BehavioralHealthSystem.Web
      dockerfile: Dockerfile.development
    ports:
      - "5173:80"
    environment:
      # API Configuration
      - VITE_API_BASE_URL=${VITE_API_BASE_URL}
      # Azure AD / Entra ID Authentication
      - VITE_AZURE_ADMIN_GROUP_ID=${VITE_AZURE_ADMIN_GROUP_ID}
      - VITE_AZURE_AUTHORITY=${VITE_AZURE_AUTHORITY}
      - VITE_AZURE_CLIENT_ID=${VITE_AZURE_CLIENT_ID}
      - VITE_AZURE_CONTROL_PANEL_GROUP_ID=${VITE_AZURE_CONTROL_PANEL_GROUP_ID}
      - VITE_AZURE_KNOWN_AUTHORITIES=${VITE_AZURE_KNOWN_AUTHORITIES}
      - VITE_AZURE_REDIRECT_URI=${VITE_AZURE_REDIRECT_URI}
      - VITE_AZURE_TENANT_ID=${VITE_AZURE_TENANT_ID}
      # Feature Flags
      - VITE_ENABLE_AUTH=${VITE_ENABLE_AUTH}
    depends_on:
      - api
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:80/"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped

# No volumes needed - all data in Azure

# Labels for container metadata
labels:
  environment: "development"
  project: "behavioral-health-system"
  managed-by: "docker-compose"
